<!DOCTYPE html>
<html>
<head>
    <title>Real-Time Sensor Data</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>ESP32 Дані сенсорів в реальному часі (DHT11, Mq-135)</h1>
    <div id="sensorData">Чекаємо на дані...</div>
    <canvas id="myChart"></canvas>

    <script>
        var conn = new WebSocket('ws://192.168.0.104:81');
        var dataTemperature = [];
        var dataHumidity = []; 
        var dataGas = []; 
        var ctx = document.getElementById('myChart').getContext('2d');
        var chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Температура (°C)',
                        data: dataTemperature,
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Вологість (%)',
                        data: dataHumidity,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    },
                    {
                        label: 'Рівень газу (Mq-135)',
                        data: dataGas,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        yAxisID: 'y2'
                    }
                ]
            },
            options: {
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false,
                        }
                    },
                    y2: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false,
                        }
                    }
                }
            }
        });

        conn.onmessage = function(e) {
            var now = new Date().toLocaleTimeString();
            var dataString = e.data;
            var parts = dataString.split(",");
            if (parts.length < 3) {
                console.error("Invalid data format: " + dataString);
                return;
            }

            var temperature = parseFloat(parts[0].split(":")[1].trim());
            var humidity = parseFloat(parts[1].split(":")[1].trim());
            var gas = parseFloat(parts[2].split(":")[1].trim());

            if (isNaN(temperature) || isNaN(humidity) || isNaN(gas)) {
                console.error("Invalid data values: " + dataString);
                return;
            }

            document.getElementById('sensorData').innerHTML = "Температура: " + temperature + " °C, Вологість: " + humidity + "%, Рівень газу: " + gas;

            if (dataTemperature.length > 20) {
                dataTemperature.shift();
                dataHumidity.shift();
                dataGas.shift();
                chart.data.labels.shift();
            }

            dataTemperature.push({x: now, y: temperature});
            dataHumidity.push({x: now, y: humidity});
            dataGas.push({x: now, y: gas});
            chart.data.labels.push(now);
            chart.update();
        };

        conn.onopen = function() {
            console.log('Підключенно');
        };

        conn.onerror = function(e) {
            console.log('Помилка!');
        };
    </script>
</body>
</html>
